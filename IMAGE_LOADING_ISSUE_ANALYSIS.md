# 图片加载问题分析

## 🔴 问题描述

**现象**：第一次清理时图片加载不出来，第二次清理才能加载出来

## 🔍 可能原因

### 1. **图片懒加载（Lazy Loading）**
- 当前使用 `loading="lazy"`，图片只有在进入视口时才会加载
- 如果卡片在视口外，图片不会加载
- **影响**：第一次打开时，如果卡片在视口外，图片不会加载

### 2. **时序问题**
```
Background.js 保存数据
  ↓ (几乎同时)
打开个人空间
  ↓
个人空间加载数据
  ↓
渲染卡片
  ↓
尝试加载图片（此时图片 URL 可能还没准备好）
```

**问题**：
- Storage 写入是异步的，虽然用了 `await`，但个人空间可能读取到旧数据
- 图片 URL 可能需要时间才能访问（CDN 延迟）

### 3. **跨域问题**
- 某些 OG 图片可能有 CORS 限制
- 浏览器可能阻止跨域图片加载

### 4. **URL 格式问题**
- 相对路径可能没有正确转换为绝对路径
- 协议问题（http vs https）

## ✅ 解决方案

### 方案 1: 改进图片加载策略

**当前问题**：
```jsx
<img
  src={getBestImageSource(og, 'text', cardWidth, cardWidth * 0.75)}
  loading="lazy"  // ❌ 懒加载可能导致首次不加载
  onError={(e) => handleImageError(e, og, 'text')}
/>
```

**改进**：
1. **预加载关键图片**：对于第一个 session 的前几张图片，不使用懒加载
2. **添加加载状态**：显示加载中状态，避免空白
3. **改进错误处理**：添加重试机制

### 方案 2: 确保 URL 格式正确

**检查点**：
- 相对路径是否正确转换为绝对路径
- 协议是否正确（http vs https）
- URL 是否有效

### 方案 3: 添加图片预加载机制

在个人空间打开后，主动预加载前几张图片，确保它们能正常显示。

### 方案 4: 改进 Storage 时序

确保 Storage 写入完成后再打开个人空间，或者添加延迟。

