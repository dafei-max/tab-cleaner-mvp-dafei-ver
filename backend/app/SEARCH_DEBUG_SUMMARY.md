# æœç´¢åŠŸèƒ½è°ƒè¯•æ€»ç»“

## âœ… æœç´¢åŠŸèƒ½éªŒè¯ç»“æœ

### æµ‹è¯•ç»“æœ

ä½¿ç”¨æµ‹è¯•è„šæœ¬ `test_search_debug.py` éªŒè¯æœç´¢åŠŸèƒ½ï¼š

```bash
python test_search_debug.py --user-id device_1764658383255_28u4om0xg --query "æ¤…å­"
```

**ç»“æœ**ï¼šâœ… **æœç´¢åŠŸèƒ½æ­£å¸¸ï¼Œè¿”å›äº† 3 ä¸ªç»“æœ**

```
ğŸ“Š æœç´¢ç»“æœ:
  æ€»ç»“æœæ•°: 3

ğŸ“‹ ç»“æœè¯¦æƒ…ï¼ˆå‰10ä¸ªï¼‰:
  1. https://www.pinterest.com/pin/463237511663116491...
     ç›¸ä¼¼åº¦: 0.6931 (é˜ˆå€¼: 0.28) âœ…
     æ ‡é¢˜: ä½ çš„ä¸ªäººèµ„æ–™...

  2. https://www.pinterest.com/pin/463237511651807696...
     ç›¸ä¼¼åº¦: 0.6313 (é˜ˆå€¼: 0.28) âœ…
     æ ‡é¢˜: Hello Breakout Chair - Product Page...

  3. https://www.pinterest.com/pin/4591701427128108544...
     ç›¸ä¼¼åº¦: 0.4306 (é˜ˆå€¼: 0.28) âœ…
     æ ‡é¢˜: ä½ çš„ä¸ªäººèµ„æ–™...
```

### æ•°æ®ç»Ÿè®¡

- âœ… ç”¨æˆ·æœ‰ 4 æ¡è®°å½•
- âœ… æ‰€æœ‰è®°å½•éƒ½æœ‰ embeddingã€caption å’Œ caption_embedding
- âœ… æœ‰ 2 æ¡è®°å½•çš„ caption åŒ…å« 'æ¤…å­'
- âœ… æœç´¢è¿”å› 3 ä¸ªç»“æœï¼Œç›¸ä¼¼åº¦éƒ½é«˜äºé˜ˆå€¼ 0.28

---

## ğŸ” å¦‚æœå‰ç«¯æ˜¾ç¤º 0 ç»“æœ

### å¯èƒ½åŸå› 

1. **ç”¨æˆ·IDä¸åŒ¹é…**
   - å‰ç«¯å‘é€çš„ç”¨æˆ·IDä¸æ•°æ®å­˜å‚¨æ—¶çš„ç”¨æˆ·IDä¸ä¸€è‡´
   - æ£€æŸ¥æ–¹æ³•ï¼šæŸ¥çœ‹æµè§ˆå™¨ Network æ ‡ç­¾ä¸­çš„ `X-User-ID` header

2. **å‰ç«¯è¯·æ±‚å¤±è´¥**
   - API è¯·æ±‚è¿”å›é”™è¯¯
   - æ£€æŸ¥æ–¹æ³•ï¼šæŸ¥çœ‹æµè§ˆå™¨ Console å’Œ Network æ ‡ç­¾

3. **å‰ç«¯è¿‡æ»¤é€»è¾‘**
   - å‰ç«¯å¯èƒ½æœ‰é¢å¤–çš„è¿‡æ»¤é€»è¾‘
   - æ£€æŸ¥æ–¹æ³•ï¼šæŸ¥çœ‹ `useSearch.js` ä¸­çš„å¤„ç†é€»è¾‘

4. **ç¼“å­˜é—®é¢˜**
   - æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ç©ºç»“æœ
   - è§£å†³æ–¹æ³•ï¼šæ¸…é™¤ç¼“å­˜æˆ–ç¡¬åˆ·æ–°ï¼ˆCmd+Shift+Rï¼‰

### è°ƒè¯•æ­¥éª¤

#### 1. æ£€æŸ¥å‰ç«¯è¯·æ±‚

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾ï¼š

1. æ‰§è¡Œæœç´¢æ“ä½œ
2. æ‰¾åˆ° `/api/v1/search/query` è¯·æ±‚
3. æ£€æŸ¥ï¼š
   - **Request Headers**ï¼šæ˜¯å¦æœ‰ `X-User-ID: device_1764658383255_28u4om0xg`
   - **Response**ï¼šæŸ¥çœ‹è¿”å›çš„ JSONï¼Œåº”è¯¥åŒ…å« `results` æ•°ç»„

**é¢„æœŸå“åº”**ï¼š
```json
{
  "ok": true,
  "results": [
    {
      "url": "...",
      "title": "...",
      "similarity": 0.6931,
      ...
    }
  ],
  "count": 3
}
```

#### 2. æ£€æŸ¥åç«¯æ—¥å¿—

åœ¨ Railway Logs ä¸­æŸ¥çœ‹ï¼š

```
[API] Search request: query='æ¤…å­'
[API] ğŸ‘¤ User ID from header: 'device_1764658383255_28u4om0xg' â†’ normalized: 'device_1764658383255_28u4om0xg'
[API] Found 3 results (dynamic filtering)
[API] Similarity range: min=0.4306, max=0.6931, count=3
```

#### 3. æ£€æŸ¥å‰ç«¯ Console

åœ¨æµè§ˆå™¨ Console ä¸­åº”è¯¥çœ‹åˆ°ï¼š

```
[useSearch] Searching for: æ¤…å­
[useSearch] Found 3 results from database
```

å¦‚æœçœ‹åˆ° `Backend returned empty, using local fuzzy ranking`ï¼Œè¯´æ˜åç«¯è¿”å›äº†ç©ºç»“æœã€‚

---

## ğŸ› ï¸ å¿«é€Ÿæµ‹è¯•æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
cd backend/app
python test_search_debug.py --user-id device_1764658383255_28u4om0xg --query "æ¤…å­"
```

### æ–¹æ³•2ï¼šç›´æ¥è°ƒç”¨ API

```bash
curl -X POST https://tab-cleaner-mvp-app-production.up.railway.app/api/v1/search/query \
  -H "Content-Type: application/json" \
  -H "X-User-ID: device_1764658383255_28u4om0xg" \
  -d '{"query": "æ¤…å­", "top_k": 20}'
```

### æ–¹æ³•3ï¼šæ£€æŸ¥æ•°æ®åº“

```bash
python diagnose_search_issue.py --user-id device_1764658383255_28u4om0xg --query "æ¤…å­"
```

---

## ğŸ“‹ æœç´¢æµç¨‹è¯´æ˜

### åç«¯æœç´¢æµç¨‹

1. **æ¥æ”¶è¯·æ±‚**ï¼š`/api/v1/search/query`
2. **ä¸‰é˜¶æ®µæ¼æ–—æœç´¢**ï¼š
   - Stage 1: Coarse Recallï¼ˆå¤šè·¯å¬å›ï¼‰
   - Stage 2: Fine Rankingï¼ˆç²¾ç»†æ’åºï¼‰
   - Stage 3: Smart Filteringï¼ˆæ™ºèƒ½è¿‡æ»¤ï¼‰
3. **è¿”å›ç»“æœ**ï¼šæŒ‰ç›¸ä¼¼åº¦æ’åºçš„ç»“æœåˆ—è¡¨

### å‰ç«¯æœç´¢æµç¨‹

1. **ç”¨æˆ·è¾“å…¥æŸ¥è¯¢**ï¼šåœ¨æœç´¢æ¡†è¾“å…¥
2. **è°ƒç”¨ API**ï¼š`searchContent(query)`
3. **å¤„ç†ç»“æœ**ï¼š`useSearch.js` ä¸­çš„ `performSearch()`
4. **æ˜¾ç¤ºç»“æœ**ï¼šåœ¨ `SearchOverlay` æˆ– `RadialCanvas` ä¸­æ˜¾ç¤º

---

## âœ… éªŒè¯æ¸…å•

- [x] åç«¯æœç´¢åŠŸèƒ½æ­£å¸¸ï¼ˆæµ‹è¯•è„šæœ¬éªŒè¯ï¼‰
- [x] æ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼ˆ4æ¡è®°å½•ï¼‰
- [x] æ‰€æœ‰è®°å½•éƒ½æœ‰ embedding
- [x] æœç´¢è¿”å›ç»“æœï¼ˆ3ä¸ªï¼‰
- [x] ç›¸ä¼¼åº¦éƒ½é«˜äºé˜ˆå€¼ï¼ˆ0.28ï¼‰
- [ ] å‰ç«¯æ­£ç¡®å‘é€ç”¨æˆ·IDï¼ˆéœ€è¦ç”¨æˆ·éªŒè¯ï¼‰
- [ ] å‰ç«¯æ­£ç¡®æ˜¾ç¤ºç»“æœï¼ˆéœ€è¦ç”¨æˆ·éªŒè¯ï¼‰

---

## ğŸ”§ å¦‚æœä»ç„¶æ˜¾ç¤º 0 ç»“æœ

### æ£€æŸ¥æ¸…å•

1. **ç”¨æˆ·IDåŒ¹é…**
   ```javascript
   // åœ¨æµè§ˆå™¨ Console è¿è¡Œ
   chrome.storage.local.get(['user_id'], (result) => {
     console.log('å½“å‰ç”¨æˆ·ID:', result.user_id);
   });
   ```
   åº”è¯¥æ˜¾ç¤ºï¼š`device_1764658383255_28u4om0xg`

2. **API è¯·æ±‚**
   - æ‰“å¼€ Network æ ‡ç­¾
   - æ£€æŸ¥ `/api/v1/search/query` è¯·æ±‚
   - æŸ¥çœ‹ Responseï¼Œåº”è¯¥åŒ…å« `results` æ•°ç»„

3. **å‰ç«¯ Console**
   - æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
   - æŸ¥çœ‹ `[useSearch]` æ—¥å¿—

4. **æ¸…é™¤ç¼“å­˜**
   - ç¡¬åˆ·æ–°ï¼šCmd+Shift+R (Mac) æˆ– Ctrl+Shift+R (Windows)
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

---

**æœ€åæ›´æ–°**: 2025-12-03

