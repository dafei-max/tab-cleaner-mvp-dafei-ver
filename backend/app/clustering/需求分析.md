# 聚类功能需求分析与设计考虑

## 需求概述

### 1. 用户自定义聚类
- **触发方式**：用户通过点选或套索选择一组卡片
- **命名**：用户给这组卡片重命名
- **布局**：这组内容形成新的圆形排列，排列在旁边
- **显示**：聚类中心显示用户自定义的聚类名称

### 2. AI 聚类模块
- **入口**：点击 AI 聚类按钮
- **弹窗功能**：
  - 左边3个标签：用户自定义的目标分类
  - 加号按钮：可以增加标签
  - 上传按钮：AI 按用户的目标标签自动分类，每类以圆形排列，圆心显示目标标签
  - 自发现聚类按钮：AI 自动分成3-5组（包含"其他"）

## 需要澄清的问题

### 1. 用户自定义聚类

**Q1.1：聚类后的卡片位置**
- 聚类后，原来的卡片是否还在原位置？
- 还是移动到新的圆形排列中？
- 如果移动，原位置是否保留占位符？

**Q1.2：圆形排列的位置**
- "排列在旁边"具体指哪里？
  - 在原画布的旁边（右侧/下方）？
  - 还是新的独立区域？
  - 多个聚类如何排列？是否支持拖拽调整位置？

**Q1.3：聚类中心显示**
- 聚类中心显示名称，是：
  - 文字标签？
  - 图标+文字？
  - 可点击/可编辑？

**Q1.4：聚类操作流程**
- 用户重命名后，是否需要点击"确认"按钮才创建聚类？
- 还是重命名后自动创建？
- 创建聚类后，选中的卡片是否自动取消选中？

### 2. AI 聚类模块

**Q2.1：标签管理**
- 初始的3个标签是什么？是固定的（如"设计"、"工作文档"、"其他"）还是用户自定义？
- 标签是否有数量限制（最多几个）？
- 标签是否可以删除/编辑？

**Q2.2：上传按钮功能**
- "上传按钮"上传的是什么？
  - 是上传选中的卡片？
  - 还是上传所有卡片？
  - 是否需要先选择卡片再点击上传？

**Q2.3：AI 分类逻辑**
- 使用什么模型进行分类？
  - 是否使用现有的 embedding（text_embedding + image_embedding）？
  - 还是调用新的分类 API？
- 分类结果如何确定？
  - 每个卡片属于哪个标签（单一分类）？
  - 还是可以属于多个标签（多标签分类）？
- 如果卡片不属于任何标签，如何处理？
  - 归入"其他"？
  - 还是单独显示？

**Q2.4：自发现聚类**
- 是否需要用户先选择卡片？
- 还是对所有卡片进行聚类？
- 聚类数量如何确定？
  - 固定3-5组？
  - 还是根据内容自动确定（最多5组）？
- 聚类名称如何生成？
  - AI 自动生成？
  - 还是使用关键词/主题词？

**Q2.5：聚类结果展示**
- 每个聚类是否独立显示？
- 聚类之间是否可以合并/拆分？
- 聚类结果是否可以保存/导出？

### 3. 通用问题

**Q3.1：聚类数据持久化**
- 聚类结果是否需要保存到本地存储？
- 刷新页面后，聚类是否保留？
- 聚类数据格式如何设计？

**Q3.2：聚类编辑功能**
- 聚类创建后，是否可以：
  - 重命名？
  - 添加/移除卡片？
  - 删除聚类？
  - 合并聚类？

**Q3.3：聚类与搜索的关系**
- 搜索功能是否影响聚类？
- 聚类后是否还能搜索？
- 搜索结果是否显示聚类信息？

**Q3.4：性能考虑**
- 大量卡片（100+）时，聚类性能如何？
- 是否需要分批处理？
- 聚类计算是同步还是异步？

## 设计考虑

### 1. 后端架构

**建议的模块结构**：
```
clustering/
├── __init__.py          # 导出主要接口
├── config.py            # 配置（聚类数量、模型等）
├── manual.py            # 用户自定义聚类逻辑
├── ai_classify.py       # AI 按标签分类
├── ai_discover.py       # AI 自发现聚类
├── layout.py            # 圆形布局计算（可复用 search 的 radialLayout）
└── storage.py           # 聚类数据持久化（可选）
```

### 2. API 设计

**建议的 API 端点**：
- `POST /api/v1/clustering/manual` - 创建用户自定义聚类
- `POST /api/v1/clustering/ai-classify` - AI 按标签分类
- `POST /api/v1/clustering/ai-discover` - AI 自发现聚类
- `GET /api/v1/clustering/list` - 获取所有聚类（如果需要）
- `PUT /api/v1/clustering/{id}` - 更新聚类（重命名、添加卡片等）
- `DELETE /api/v1/clustering/{id}` - 删除聚类

### 3. 数据模型

**聚类数据结构**：
```python
{
    "id": "cluster-xxx",
    "name": "用户自定义名称",
    "type": "manual" | "ai-classify" | "ai-discover",
    "items": [  # 卡片 ID 列表
        "og-1", "og-2", ...
    ],
    "center": {  # 聚类中心位置
        "x": 720,
        "y": 512
    },
    "radius": 200,  # 圆形排列半径
    "created_at": "2025-11-06T...",
    "labels": ["设计", "工作文档"],  # AI 分类的标签（如果有）
}
```

### 4. AI 分类实现方案

**方案A：基于现有 Embedding**
- 优点：复用现有 embedding，速度快
- 缺点：需要预先计算 embedding

**方案B：调用新的分类 API**
- 优点：更专业的分类结果
- 缺点：需要额外的 API 调用，成本更高

**建议**：使用方案A，基于现有 embedding 进行聚类

### 5. 前端状态管理

**需要新增的状态**：
- `clusters`: 聚类列表
- `activeClusterId`: 当前激活的聚类
- `clusteringMode`: 聚类模式（manual/ai-classify/ai-discover）

### 6. 布局计算

**圆形排列**：
- 可以复用 `calculateRadialLayout` 函数
- 每个聚类独立计算布局
- 聚类中心位置需要计算（避免重叠）

## 建议的实现顺序

1. **Phase 1：用户自定义聚类**
   - 后端 API：创建聚类
   - 前端：选择卡片 → 重命名 → 创建聚类 → 显示圆形排列

2. **Phase 2：AI 按标签分类**
   - 后端：基于 embedding 进行分类
   - 前端：标签管理 → 上传 → 显示分类结果

3. **Phase 3：AI 自发现聚类**
   - 后端：无监督聚类算法（K-means/层次聚类）
   - 前端：一键聚类 → 显示结果

## 待确认的关键问题

1. **聚类位置**：在原画布上还是新区域？
2. **卡片移动**：聚类后卡片是否移动？
3. **标签初始值**：初始3个标签是什么？
4. **上传内容**：上传按钮上传的是什么？
5. **分类方式**：单一分类还是多标签分类？
6. **聚类数量**：自发现聚类的数量如何确定？

请确认以上问题，我再开始实现代码。

