# 搜索系统重构说明

## 重构目标

统一使用 `qwen2.5-vl-embedding` 模型处理文本和图像，确保它们在同一个向量空间（1024维），实现"同模态向量二路融合"。

## 主要改动

### 1. 统一 Embedding 模块 (`embed.py`)

**之前**：
- `embed_text.py`：使用 `text-embedding-v4`（1024维）
- `embed_image.py`：使用 `tongyi-embedding-vision-plus`（1152维）

**现在**：
- `embed.py`：统一使用 `qwen2.5-vl-embedding`
  - `embed_text()`: 文本 → 1024维向量
  - `embed_image()`: 图像 → 1024维向量
  - 两者在同一向量空间，可直接比较

### 2. 简化相似度计算 (`rank.py`)

**之前**：
- 需要处理维度不匹配（1024 vs 1152）
- 使用 PCA 降维或简单截断
- 跨模型空间对齐

**现在**：
- 文本和图像都在同一向量空间（1024维）
- 直接计算余弦相似度，无需降维
- `s_text = cos(q_vec, doc_text_vec)`（同空间）
- `s_image = cos(q_vec, doc_img_vec)`（同空间）

### 3. 简化融合逻辑 (`fuse.py`)

**之前**：
- `fuse_text_image()`: 融合向量（需要处理维度不匹配）
- PCA 降维逻辑

**现在**：
- `fuse_similarity_scores()`: 融合相似度分数（标量）
- `normalize_scores()`: 归一化分数（Min-Max 或 Z-score）
- 移除向量融合逻辑（不再需要）

### 4. 更新 Pipeline (`pipeline.py`)

**之前**：
- 生成融合向量 `embedding`
- 分别保存 `text_embedding` 和 `image_embedding`

**现在**：
- 只保存 `text_embedding` 和 `image_embedding`（都在1024维）
- 不再生成融合向量 `embedding`
- 搜索时直接使用两路相似度融合

### 5. 自适应权重 (`rank.py`)

根据内容类型自动选择权重：

- **视觉站**（Pinterest/Behance/Dribbble/INS）：`score = 0.4*s_text + 0.6*s_image`
- **文本站**（博客/文档/知乎）：`score = 0.8*s_text + 0.2*s_image`
- **默认**：`score = 0.6*s_text + 0.4*s_image`

## 数据流

### 入库阶段（离线/增量）

```
每个标签页：
├─ 文本：title + og:title + og:description → doc_text_vec (1024维)
└─ 图像：首屏截图 或 OG:image → doc_img_vec (1024维)

存储：
├─ text_embedding: doc_text_vec
└─ image_embedding: doc_img_vec
```

### 查询阶段（在线）

```
查询文本 → q_vec (1024维)

两路相似度：
├─ s_text = cos(q_vec, doc_text_vec)  [同空间，直接比较]
└─ s_image = cos(q_vec, doc_img_vec)  [同空间，直接比较]

归一化后融合：
├─ 视觉站：score = 0.4*s_text + 0.6*s_image
├─ 文本站：score = 0.8*s_text + 0.2*s_image
└─ 默认：score = 0.6*s_text + 0.4*s_image

排序 → 返回 top_k
```

## 优势

1. **同一向量空间**：文本和图像都在 1024 维空间，可直接比较
2. **无需降维**：不再需要 PCA 降维或简单截断
3. **信息完整**：保留完整的文本和图像信息
4. **代码简洁**：移除复杂的维度处理逻辑
5. **灵活权重**：根据内容类型自适应调整权重

## 文件变更

### 新增
- `search/embed.py`：统一的 embedding 模块

### 删除
- `search/embed_text.py`：已合并到 `embed.py`
- `search/embed_image.py`：已合并到 `embed.py`

### 更新
- `search/config.py`：统一配置，移除 TEXT_EMBED 相关配置
- `search/pipeline.py`：使用新的 `embed.py`，移除融合向量生成
- `search/rank.py`：简化相似度计算，移除维度处理
- `search/fuse.py`：只做分数融合，移除向量融合

## 兼容性

- 旧数据（有 `embedding` 融合向量）：会自动使用 fallback
- 新数据（只有 `text_embedding` 和 `image_embedding`）：使用新的两路融合

## 测试建议

1. 重启后端服务
2. 重新生成 embedding（调用 `/api/v1/search/embedding`）
3. 测试搜索功能，确认相似度不再为 0
4. 检查日志中的维度信息（应该都是 1024 维）





