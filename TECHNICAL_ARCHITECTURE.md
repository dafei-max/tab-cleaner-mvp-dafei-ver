# Tab Cleaner MVP - å®Œæ•´æŠ€æœ¯æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
3. [åç«¯æ¶æ„](#åç«¯æ¶æ„)
4. [æ•°æ®åº“æ¶æ„](#æ•°æ®åº“æ¶æ„)
5. [é€šä¿¡åè®®](#é€šä¿¡åè®®)
6. [æ•°æ®æµ](#æ•°æ®æµ)
7. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)

---

## ç³»ç»Ÿæ¦‚è§ˆ

Tab Cleaner MVP æ˜¯ä¸€ä¸ªåŸºäº Chrome æ‰©å±•çš„æ ‡ç­¾é¡µç®¡ç†å·¥å…·ï¼Œé‡‡ç”¨**å‰åç«¯åˆ†ç¦»**æ¶æ„ï¼Œæ”¯æŒ**æœ¬åœ°ä¼˜å…ˆï¼ˆLocal-Firstï¼‰**çš„æ•°æ®å¤„ç†ç­–ç•¥ã€‚

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Chrome æµè§ˆå™¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Chrome Extension                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Background   â”‚  â”‚  Content     â”‚  â”‚  Popup/      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Service      â”‚  â”‚  Scripts     â”‚  â”‚  Sidepanel    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Worker       â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (background.js)â”‚ â”‚(content.js, â”‚  â”‚ (React App)  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚              â”‚  â”‚ pet.js)      â”‚  â”‚              â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚         â”‚                  â”‚                  â”‚         â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚  â”‚                           â”‚                              â”‚  â”‚
â”‚  â”‚                    Chrome Storage                        â”‚  â”‚
â”‚  â”‚              (local storage, sessions)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ HTTPS API
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend Server                               â”‚
â”‚              (FastAPI + Python)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Endpoints                                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ POST /api/v1/search/embedding                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ POST /api/v1/search/query                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ DELETE /api/v1/tabs/{url}                            â”‚  â”‚
â”‚  â”‚  â””â”€ DELETE /api/v1/sessions/{session_id}                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Search Pipeline                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Query Enhancement (query_enhance.py)                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ Embedding Generation (embed.py)                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Multi-way Recall (pipeline.py)                        â”‚  â”‚
â”‚  â”‚  â””â”€ Re-ranking (rank.py, fuse.py)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AI Services                                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ DashScope API (é€šä¹‰åƒé—®)                              â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ qwen2.5-vl-embedding (æ–‡æœ¬+å›¾åƒ)                  â”‚  â”‚
â”‚  â”‚  â””â”€ AI Insight (ai_insight.py)                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ PostgreSQL Protocol
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Aliyun AnalyticDB PostgreSQL                           â”‚
â”‚              (å‘é‡æ•°æ®åº“)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Schema: cleantab                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ opengraph_items_v2                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ user_id (TEXT)                                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ url (TEXT)                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ title, description, image, site_name            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ text_embedding (vector(1024))                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ image_embedding (vector(1024))                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ status (active/deleted)                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ deleted_at (TIMESTAMP)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ metadata (JSONB)                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€ PRIMARY KEY (user_id, url)                       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Indexes                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ idx_user_text_embedding (IVFFlat)                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â”œâ”€ idx_user_image_embedding (IVFFlat)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€ idx_user_id (B-tree)                             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‰ç«¯æ¶æ„

### 1. Chrome Extension ç»“æ„

#### 1.1 Background Service Worker (`background.js`)

**èŒè´£**ï¼š
- åè°ƒæ ‡ç­¾é¡µæ¸…ç†æµç¨‹
- ç®¡ç† OpenGraph æ•°æ®æ”¶é›†
- ä¸åç«¯ API é€šä¿¡
- å¤„ç†æˆªå›¾å…œåº•é€»è¾‘

**å…³é”®åŠŸèƒ½**ï¼š
```javascript
// ä¸‰å±‚ä¿é™©ç­–ç•¥ç¡®ä¿å›¾ç‰‡æ•è·
1. æ³¨å…¥ opengraph_local.js æå– OG æ•°æ®
2. è½®è¯¢ç­‰å¾…åŠ¨æ€ OG æ ‡ç­¾åŠ è½½ï¼ˆMutationObserverï¼‰
3. æˆªå›¾å…œåº•ï¼ˆcaptureTabScreenshotï¼‰
```

**æ¶ˆæ¯å¤„ç†**ï¼š
- `clean-all`: æ¸…ç†æ‰€æœ‰æ ‡ç­¾é¡µ
- `clean-current-tab`: æ¸…ç†å½“å‰æ ‡ç­¾é¡µ
- `clean`: æ¸…ç†æŒ‡å®šæ ‡ç­¾é¡µ

#### 1.2 Content Scripts

**`content.js`**ï¼š
- æ˜¾ç¤ºæ¸…ç†å¡ç‰‡ UI
- å¤„ç†æ¸…ç†æŒ‰é’®ç‚¹å‡»
- æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
- ä» Chrome Storage è¯»å– OpenGraph ç¼“å­˜

**`pet.js`**ï¼š
- æ¡Œé¢å® ç‰©åŠŸèƒ½
- å® ç‰©æ‹–æ‹½å’Œäº¤äº’
- æ¸…ç†æ“ä½œå…¥å£

**`opengraph_local.js`**ï¼š
- åœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­æå– OpenGraph æ•°æ®
- æ”¯æŒåŠ¨æ€å†…å®¹ï¼ˆSPAï¼‰æ£€æµ‹
- URL å˜åŒ–ç›‘å¬ï¼ˆpopstate, hashchange, history APIï¼‰
- MutationObserver ç›‘å¬åŠ¨æ€ OG æ ‡ç­¾

#### 1.3 React åº”ç”¨ï¼ˆä¸ªäººç©ºé—´ï¼‰

**æŠ€æœ¯æ ˆ**ï¼š
- React 18.3.1
- Vite 6.0.4
- Framer Motionï¼ˆåŠ¨ç”»ï¼‰
- Three.js + React Three Fiberï¼ˆ3D è§†å›¾ï¼‰
- Tailwind CSS

**æ ¸å¿ƒç»„ä»¶**ï¼š
```
src/screens/PersonalSpace/
â”œâ”€â”€ PersonalSpace.jsx          # ä¸»ç»„ä»¶
â”œâ”€â”€ SessionMasonryGrid.jsx      # ç½‘æ ¼è§†å›¾
â”œâ”€â”€ RadialCanvas.jsx            # æ”¾å°„çŠ¶è§†å›¾
â”œâ”€â”€ SessionCard.jsx             # å¡ç‰‡ç»„ä»¶
â”œâ”€â”€ SearchBar.jsx               # æœç´¢æ 
â”œâ”€â”€ ScrollSpyIndicator.jsx     # æ»šåŠ¨æŒ‡ç¤ºå™¨
â””â”€â”€ hooks/
    â”œâ”€â”€ useSearch.js            # æœç´¢é€»è¾‘
    â”œâ”€â”€ useSessionManager.js    # Session ç®¡ç†
    â””â”€â”€ useCanvasInteractions.js # ç”»å¸ƒäº¤äº’
```

**çŠ¶æ€ç®¡ç†**ï¼š
- React Hooksï¼ˆuseState, useEffect, useRefï¼‰
- Chrome Storage APIï¼ˆæŒä¹…åŒ–ï¼‰
- å…¨å±€çŠ¶æ€å¯¹è±¡ï¼ˆwindow.__OG_EXTRACTION_STATUSï¼‰

### 2. å‰ç«¯æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ
  â†“
Chrome Extension (background.js)
  â”œâ”€ æ”¶é›† OpenGraph æ•°æ®
  â”œâ”€ ä¿å­˜åˆ° Chrome Storage (sessions)
  â”œâ”€ å…³é—­æ ‡ç­¾é¡µ
  â””â”€ æ‰“å¼€ä¸ªäººç©ºé—´
      â†“
React App (PersonalSpace.jsx)
  â”œâ”€ ä» Chrome Storage è¯»å–æ•°æ®
  â”œâ”€ ç«‹å³æ¸²æŸ“ï¼ˆä¸ç­‰å¾…åç«¯ï¼‰
  â””â”€ å¼‚æ­¥å‘é€åˆ°åç«¯ç”Ÿæˆ embedding
      â†“
åç«¯ API (/api/v1/search/embedding)
  â”œâ”€ ç”Ÿæˆ embedding
  â”œâ”€ ä¿å­˜åˆ°å‘é‡æ•°æ®åº“
  â””â”€ è¿”å›ç»“æœ
```

---

## åç«¯æ¶æ„

### 1. æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: FastAPI (Python 3.9+)
- **æ•°æ®åº“**: Aliyun AnalyticDB PostgreSQL (å‘é‡æ•°æ®åº“)
- **AI æœåŠ¡**: é˜¿é‡Œäº‘ DashScope API (é€šä¹‰åƒé—®)
- **å¼‚æ­¥**: asyncio, asyncpg

### 2. æ ¸å¿ƒæ¨¡å—

#### 2.1 API è·¯ç”± (`main.py`)

**ä¸»è¦ç«¯ç‚¹**ï¼š

```python
POST /api/v1/search/embedding
  - æ¥æ”¶ OpenGraph æ•°æ®
  - ç”Ÿæˆæ–‡æœ¬å’Œå›¾åƒ embedding
  - ä¿å­˜åˆ°å‘é‡æ•°æ®åº“
  - æ”¯æŒæ‰¹é‡å¤„ç†

POST /api/v1/search/query
  - æ¥æ”¶æŸ¥è¯¢æ–‡æœ¬
  - æŸ¥è¯¢å¢å¼ºï¼ˆé¢œè‰²ã€é£æ ¼è¯†åˆ«ï¼‰
  - å¤šè·¯å¬å›ï¼ˆå‘é‡ã€å…³é”®è¯ã€è§†è§‰ï¼‰
  - é‡æ’åºå’Œç›¸ä¼¼åº¦è¿‡æ»¤

DELETE /api/v1/tabs/{url}
  - è½¯åˆ é™¤å•ä¸ªæ ‡ç­¾é¡µ

DELETE /api/v1/sessions/{session_id}
  - è½¯åˆ é™¤æ•´ä¸ª session
```

#### 2.2 æœç´¢ Pipeline (`search/pipeline.py`)

**æµç¨‹**ï¼š
```
æŸ¥è¯¢æ–‡æœ¬
  â†“
æŸ¥è¯¢å¢å¼º (enhance_query)
  â”œâ”€ é¢œè‰²è¯†åˆ«ï¼ˆè“è‰² â†’ blueï¼‰
  â”œâ”€ é£æ ¼è¯†åˆ«ï¼ˆç°ä»£ â†’ modernï¼‰
  â””â”€ åŒä¹‰è¯æ‰©å±•
  â†“
ç”ŸæˆæŸ¥è¯¢å‘é‡ (embed_text)
  â†“
å¤šè·¯å¬å›
  â”œâ”€ å‘é‡æœç´¢ (search_by_text_embedding)
  â”œâ”€ å…³é”®è¯æœç´¢ (fuzzy_score)
  â””â”€ è§†è§‰å±æ€§æœç´¢
  â†“
é‡æ’åº (fuse_similarity_scores)
  â”œâ”€ è‡ªé€‚åº”æƒé‡
  â””â”€ ç›¸ä¼¼åº¦èåˆ
  â†“
è¿‡æ»¤ (MIN_SIMILARITY_THRESHOLD = 0.15)
  â†“
è¿”å›ç»“æœ
```

#### 2.3 Embedding ç”Ÿæˆ (`search/embed.py`)

**æ¨¡å‹**: `qwen2.5-vl-embedding`
- **ç»´åº¦**: 1024
- **ç»Ÿä¸€å‘é‡ç©ºé—´**: æ–‡æœ¬å’Œå›¾åƒåœ¨åŒä¸€ç©ºé—´ï¼Œå¯ç›´æ¥æ¯”è¾ƒ
- **API**: é˜¿é‡Œäº‘ DashScope

**å¤„ç†æµç¨‹**ï¼š
```python
æ–‡æœ¬ Embedding:
  text â†’ embed_text() â†’ vector(1024)

å›¾åƒ Embedding:
  image_url â†’ download_image() 
    â†’ process_image() (ç¼©æ”¾ã€å‹ç¼©ã€Base64)
    â†’ embed_image() â†’ vector(1024)
```

#### 2.4 å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯ (`vector_db.py`)

**åŠŸèƒ½**ï¼š
- è¿æ¥æ± ç®¡ç†ï¼ˆasyncpg.Poolï¼‰
- Schema åˆå§‹åŒ–ï¼ˆ`init_schema()`ï¼‰
- CRUD æ“ä½œï¼ˆ`upsert_opengraph_item()`, `get_opengraph_item()`ï¼‰
- å‘é‡æœç´¢ï¼ˆ`search_by_text_embedding()`, `search_by_image_embedding()`ï¼‰
- è½¯åˆ é™¤ï¼ˆ`soft_delete_tab()`, `soft_delete_session_tabs()`ï¼‰

**ç”¨æˆ·éš”ç¦»**ï¼š
- æ‰€æœ‰æŸ¥è¯¢éƒ½åŒ…å« `WHERE user_id = $1`
- å¤åˆä¸»é”®ï¼š`(user_id, url)`

---

## æ•°æ®åº“æ¶æ„

### 1. è¡¨ç»“æ„

#### `opengraph_items_v2`

```sql
CREATE TABLE cleantab.opengraph_items_v2 (
    user_id TEXT NOT NULL,
    url TEXT NOT NULL,
    title TEXT,
    description TEXT,
    image TEXT,
    site_name TEXT,
    tab_id INTEGER,
    tab_title TEXT,
    text_embedding vector(1024),
    image_embedding vector(1024),
    metadata JSONB,
    status TEXT DEFAULT 'active',  -- 'active' | 'deleted'
    deleted_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (user_id, url)
);
```

### 2. ç´¢å¼•

```sql
-- å‘é‡ç´¢å¼•ï¼ˆIVFFlatï¼Œç”¨äºå¿«é€Ÿç›¸ä¼¼åº¦æœç´¢ï¼‰
CREATE INDEX idx_user_text_embedding 
  ON opengraph_items_v2 
  USING ivfflat (text_embedding vector_cosine_ops);

CREATE INDEX idx_user_image_embedding 
  ON opengraph_items_v2 
  USING ivfflat (image_embedding vector_cosine_ops);

-- ç”¨æˆ· ID ç´¢å¼•ï¼ˆB-treeï¼Œç”¨äºå¿«é€Ÿè¿‡æ»¤ï¼‰
CREATE INDEX idx_user_id 
  ON opengraph_items_v2 (user_id);

-- çŠ¶æ€ç´¢å¼•ï¼ˆç”¨äºè½¯åˆ é™¤æŸ¥è¯¢ï¼‰
CREATE INDEX idx_status 
  ON opengraph_items_v2 (status) 
  WHERE status = 'active';
```

### 3. æ•°æ®è¿ç§»

**æ—§è¡¨**: `opengraph_items` (æ—  user_id)
**æ–°è¡¨**: `opengraph_items_v2` (æ”¯æŒ user_id å’Œè½¯åˆ é™¤)

**è¿ç§»è„šæœ¬**: `migrate_data.py`
- å°†æ—§æ•°æ®è¿ç§»åˆ°æ–°è¡¨
- è®¾ç½® `user_id = 'anonymous'`
- è®¾ç½® `status = 'active'`

---

## é€šä¿¡åè®®

### 1. å‰ç«¯ â†’ åç«¯

**è¯·æ±‚æ ¼å¼**ï¼š
```json
POST /api/v1/search/embedding
Headers:
  Content-Type: application/json
  X-User-ID: <user_id>  // å¯é€‰ï¼Œé»˜è®¤ "anonymous"

Body:
{
  "opengraph_items": [
    {
      "url": "https://example.com",
      "title": "Example",
      "description": "...",
      "image": "https://example.com/image.jpg",
      "site_name": "Example Site",
      "is_doc_card": false,
      "is_screenshot": false,
      "success": true
    }
  ]
}
```

**å“åº”æ ¼å¼**ï¼š
```json
{
  "ok": true,
  "processed": 5,
  "items": [
    {
      "url": "https://example.com",
      "text_embedding": [0.1, 0.2, ...],  // 1024 ç»´
      "image_embedding": [0.3, 0.4, ...], // 1024 ç»´
      "has_embedding": true
    }
  ]
}
```

### 2. æœç´¢è¯·æ±‚

**è¯·æ±‚æ ¼å¼**ï¼š
```json
POST /api/v1/search/query
Headers:
  Content-Type: application/json
  X-User-ID: <user_id>

Body:
{
  "query": "è“è‰²è®¾è®¡",
  "top_k": 20
}
```

**å“åº”æ ¼å¼**ï¼š
```json
{
  "ok": true,
  "results": [
    {
      "url": "https://example.com",
      "title": "è“è‰²è®¾è®¡ä½œå“",
      "image": "https://example.com/image.jpg",
      "similarity": 0.85,
      "text_sim": 0.80,
      "image_sim": 0.90
    }
  ]
}
```

### 3. æ¶ˆæ¯ä¼ é€’ï¼ˆChrome Extensionï¼‰

**Background â†” Content Script**ï¼š
```javascript
// Background â†’ Content
chrome.tabs.sendMessage(tabId, {
  action: 'extract-opengraph-with-wait'
});

// Content â†’ Background
chrome.runtime.sendMessage({
  action: 'opengraph-data',
  data: { ... }
});
```

**Content â†” Page Context**ï¼š
```javascript
// Content â†’ Page (opengraph_local.js)
window.postMessage({
  type: 'TAB_CLEANER_GET_OPENGRAPH'
}, '*');

// Page â†’ Content
window.addEventListener('message', (event) => {
  if (event.data.type === 'TAB_CLEANER_OPENGRAPH_DATA') {
    // å¤„ç†æ•°æ®
  }
});
```

---

## æ•°æ®æµ

### 1. æ ‡ç­¾é¡µæ¸…ç†æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"æ¸…ç†æ‰€æœ‰æ ‡ç­¾é¡µ"
  â†“
background.js: collectTabWithGuaranteedImage()
  â”œâ”€ æ³¨å…¥ opengraph_local.js
  â”œâ”€ å‘é€ extract-opengraph-with-wait æ¶ˆæ¯
  â”œâ”€ è½®è¯¢ç­‰å¾… OG æ•°æ®ï¼ˆæœ€å¤š 8 ç§’ï¼‰
  â”œâ”€ å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œæˆªå›¾å…œåº•
  â””â”€ æ”¶é›†æ‰€æœ‰æ ‡ç­¾é¡µæ•°æ®
  â†“
ä¿å­˜åˆ° Chrome Storage (sessions)
  â†“
å…³é—­æ ‡ç­¾é¡µï¼ˆä»…å…³é—­æœ‰å›¾ç‰‡çš„æ ‡ç­¾é¡µï¼‰
  â†“
æ‰“å¼€ä¸ªäººç©ºé—´ï¼ˆç«‹å³æ¸²æŸ“ï¼Œä¸ç­‰å¾…åç«¯ï¼‰
  â†“
å¼‚æ­¥å‘é€åˆ°åç«¯ (/api/v1/search/embedding)
  â”œâ”€ ç”Ÿæˆ embedding
  â”œâ”€ ä¿å­˜åˆ°å‘é‡æ•°æ®åº“
  â””â”€ æ›´æ–° Chrome Storage
```

### 2. æœç´¢æµç¨‹

```
ç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥"è“è‰²è®¾è®¡"
  â†“
å‰ç«¯: performSearch()
  â”œâ”€ è°ƒç”¨ searchContent(query)
  â†“
åç«¯: POST /api/v1/search/query
  â”œâ”€ æŸ¥è¯¢å¢å¼ºï¼ˆ"è“è‰²è®¾è®¡" â†’ "blue design"ï¼‰
  â”œâ”€ ç”ŸæˆæŸ¥è¯¢å‘é‡
  â”œâ”€ å‘é‡æœç´¢ï¼ˆWHERE user_id = $1ï¼‰
  â”œâ”€ å…³é”®è¯æœç´¢ï¼ˆfuzzy_scoreï¼‰
  â”œâ”€ è§†è§‰å±æ€§æœç´¢
  â”œâ”€ é‡æ’åºï¼ˆèåˆå¤šè·¯ç»“æœï¼‰
  â””â”€ è¿‡æ»¤ï¼ˆsimilarity >= 0.15ï¼‰
  â†“
è¿”å›ç»“æœï¼ˆæŒ‰ç›¸ä¼¼åº¦æ’åºï¼‰
  â†“
å‰ç«¯: è®¡ç®—æ”¾å°„çŠ¶å¸ƒå±€
  â”œâ”€ æœ€ç›¸å…³åœ¨å†…ç¯
  â””â”€ å‘å¤–é€’å‡
  â†“
æ¸²æŸ“æœç´¢ç»“æœ
```

---

## æŠ€æœ¯æ ˆ

### å‰ç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| React | 18.3.1 | UI æ¡†æ¶ |
| Vite | 6.0.4 | æ„å»ºå·¥å…· |
| Framer Motion | 12.0.0 | åŠ¨ç”»åº“ |
| Three.js | 0.170.0 | 3D æ¸²æŸ“ |
| React Three Fiber | 8.18.0 | Three.js React ç»‘å®š |
| Tailwind CSS | 4.1.17 | CSS æ¡†æ¶ |
| Chrome Extension API | - | æµè§ˆå™¨æ‰©å±• API |

### åç«¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| FastAPI | - | Web æ¡†æ¶ |
| Python | 3.9+ | ç¼–ç¨‹è¯­è¨€ |
| asyncpg | 0.30.0+ | PostgreSQL å¼‚æ­¥é©±åŠ¨ |
| asyncio | - | å¼‚æ­¥ç¼–ç¨‹ |
| DashScope SDK | - | é˜¿é‡Œäº‘ AI API |

### æ•°æ®åº“

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Aliyun AnalyticDB PostgreSQL | - | å‘é‡æ•°æ®åº“ |
| PostgreSQL | - | å…³ç³»å‹æ•°æ®åº“ |
| pgvector | - | å‘é‡æ‰©å±• |

### AI æœåŠ¡

| æœåŠ¡ | æ¨¡å‹ | ç”¨é€” |
|------|------|------|
| é˜¿é‡Œäº‘ DashScope | qwen2.5-vl-embedding | æ–‡æœ¬å’Œå›¾åƒ embedding |
| é˜¿é‡Œäº‘ DashScope | qwen-plus | AI æ´å¯Ÿåˆ†æ |

---

## éƒ¨ç½²æ¶æ„

### å‰ç«¯

- **æ„å»º**: `npm run build:full`
- **è¾“å‡º**: `frontend/dist/`
- **æ‰“åŒ…**: `package-extension.sh` â†’ `tab-cleaner-extension.zip`
- **åˆ†å‘**: Chrome Web Store

### åç«¯

- **éƒ¨ç½²å¹³å°**: Railway
- **ç¯å¢ƒå˜é‡**:
  - `ADBPG_HOST`: æ•°æ®åº“ä¸»æœº
  - `ADBPG_DBNAME`: æ•°æ®åº“å
  - `ADBPG_USER`: æ•°æ®åº“ç”¨æˆ·
  - `ADBPG_PASSWORD`: æ•°æ®åº“å¯†ç 
  - `DASHSCOPE_API_KEY`: AI API å¯†é’¥
- **å¯åŠ¨**: `uvicorn main:app --host 0.0.0.0 --port 8000`

### æ•°æ®åº“

- **å¹³å°**: é˜¿é‡Œäº‘ AnalyticDB PostgreSQL
- **è¿æ¥**: é€šè¿‡ `asyncpg` è¿æ¥æ± 
- **Schema**: `cleantab`
- **è¡¨**: `opengraph_items_v2`

---

## å®‰å…¨ä¸éšç§

### 1. ç”¨æˆ·éš”ç¦»

- æ‰€æœ‰æ•°æ®æ“ä½œéƒ½åŒ…å« `user_id` è¿‡æ»¤
- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- æœç´¢ä»…è¿”å›å½“å‰ç”¨æˆ·çš„ç»“æœ

### 2. è½¯åˆ é™¤

- åˆ é™¤æ“ä½œä¸ç‰©ç†åˆ é™¤æ•°æ®
- æ ‡è®°ä¸º `status = 'deleted'`
- 30 å¤©åè‡ªåŠ¨æ¸…ç†æˆ–åŒ¿ååŒ–

### 3. æ•°æ®åŠ å¯†

- HTTPS é€šä¿¡
- æ•°æ®åº“è¿æ¥ä½¿ç”¨ SSLï¼ˆå¯é€‰ï¼‰
- API Key å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å‰ç«¯

- **æ‡’åŠ è½½**: å›¾ç‰‡æ‡’åŠ è½½
- **ç¼“å­˜**: Chrome Storage ç¼“å­˜ OpenGraph æ•°æ®
- **å¼‚æ­¥å¤„ç†**: åç«¯ embedding ç”Ÿæˆä¸é˜»å¡ UI
- **æ‰¹é‡å¤„ç†**: æ‰¹é‡å‘é€ embedding è¯·æ±‚ï¼ˆæ¯æ‰¹ 5 ä¸ªï¼‰

### 2. åç«¯

- **è¿æ¥æ± **: asyncpg è¿æ¥æ± ï¼ˆmin=2, max=10ï¼‰
- **å¼‚æ­¥å¤„ç†**: æ‰€æœ‰ I/O æ“ä½œå¼‚æ­¥
- **æ‰¹é‡å¤„ç†**: æ‰¹é‡ç”Ÿæˆ embedding
- **ç´¢å¼•ä¼˜åŒ–**: IVFFlat å‘é‡ç´¢å¼•åŠ é€Ÿæœç´¢

### 3. æ•°æ®åº“

- **å‘é‡ç´¢å¼•**: IVFFlat ç´¢å¼•åŠ é€Ÿç›¸ä¼¼åº¦æœç´¢
- **çŠ¶æ€ç´¢å¼•**: éƒ¨åˆ†ç´¢å¼•ï¼ˆWHERE status = 'active'ï¼‰
- **ç”¨æˆ·ç´¢å¼•**: B-tree ç´¢å¼•åŠ é€Ÿç”¨æˆ·è¿‡æ»¤

---

## æ‰©å±•æ€§

### 1. æ°´å¹³æ‰©å±•

- åç«¯æ— çŠ¶æ€ï¼Œå¯éƒ¨ç½²å¤šä¸ªå®ä¾‹
- æ•°æ®åº“æ”¯æŒè¯»å†™åˆ†ç¦»ï¼ˆAnalyticDBï¼‰
- è¿æ¥æ± æ”¯æŒå¤šå®ä¾‹å…±äº«

### 2. å‚ç›´æ‰©å±•

- å‘é‡ç´¢å¼•å¯è°ƒæ•´å‚æ•°ï¼ˆIVFFlat listsï¼‰
- æ‰¹é‡å¤„ç†å¤§å°å¯é…ç½®
- è¿æ¥æ± å¤§å°å¯è°ƒæ•´

---

## ç›‘æ§ä¸æ—¥å¿—

### 1. å‰ç«¯æ—¥å¿—

- `console.log` / `console.warn` / `console.error`
- Chrome DevTools æŸ¥çœ‹

### 2. åç«¯æ—¥å¿—

- FastAPI è‡ªåŠ¨æ—¥å¿—
- æ‰“å°åˆ°æ ‡å‡†è¾“å‡º
- Railway è‡ªåŠ¨æ”¶é›†

### 3. æ•°æ®åº“ç›‘æ§

- é€šè¿‡ AnalyticDB æ§åˆ¶å°ç›‘æ§
- æŸ¥è¯¢æ€§èƒ½åˆ†æ
- è¿æ¥æ± çŠ¶æ€

---

## æ€»ç»“

Tab Cleaner MVP é‡‡ç”¨**å‰åç«¯åˆ†ç¦»**ã€**æœ¬åœ°ä¼˜å…ˆ**çš„æ¶æ„è®¾è®¡ï¼Œé€šè¿‡ Chrome Extension å®ç°æ ‡ç­¾é¡µç®¡ç†ï¼Œé€šè¿‡å‘é‡æ•°æ®åº“å®ç°è¯­ä¹‰æœç´¢ï¼Œé€šè¿‡ AI æœåŠ¡å®ç°æ™ºèƒ½åˆ†æã€‚æ•´ä¸ªç³»ç»Ÿæ”¯æŒç”¨æˆ·éš”ç¦»ã€è½¯åˆ é™¤ã€å¼‚æ­¥å¤„ç†ç­‰ç‰¹æ€§ï¼Œå…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚

